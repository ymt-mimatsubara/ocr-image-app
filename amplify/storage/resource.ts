// amplify/storage/resource.ts（完成版）
import { defineStorage } from "@aws-amplify/backend";
import { processImageOcr } from "../functions/ocr/resource";  // Lambda関数をインポート

// ============================================================================
// 【1. S3ストレージの定義とアクセス制御】
// Day1で学習したStorage設定に、今回はトリガー機能を追加
// ============================================================================

export const storage = defineStorage({
  // バケット名の設定
  name: "ocrStorage",
  
  // ============================================================================
  // 【2. アクセス権限の設定】
  // ファイルパスごとに誰がどの操作をできるかを定義
  // ============================================================================
  access: (allow) => ({
    // media/フォルダ以下のファイルに対する権限
    'media/*': [
      // ログインユーザー：読み書き削除すべて可能
      allow.authenticated.to(['read', 'write', 'delete']),
    ],
  }),

  // ============================================================================
  // 【3. S3トリガーの設定】
  // ファイルがアップロードされた瞬間にLambda関数を自動実行
  // ============================================================================
  triggers: {
    // onUpload：ファイルアップロード時にprocessImageOcr関数を実行
    onUpload: processImageOcr,
  },
});
